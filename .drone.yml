workspace:
  base: /go
  path: src/graduate-project

pipeline:
  clone:
  image: docker:git
  commands:
  - git clone https://github.com/JieJhih/cicd.git
  - git fetch origin +refs/heads/master
  - git checkout master
  - git fetch origin refs/pull/${DRONE_PULL_REQUEST}/head
  - git merge ${DRONE_COMMIT_SHA}

  test:
    image: golang
    commands:
      - go test
    when:
      event: pull_request

  update-success:
    image: cloudposse/github-status-updater
    secrets:
      - source: token
        target: GITHUB_TOKEN
    environment:
      - GITHUB_ACTION=update_state
      - GITHUB_OWNER=JieJhih
      - GITHUB_REPO=cicd
      - GITHUB_REF=${DRONE_COMMIT_SHA}
      - GITHUB_CONTEXT=Staging Environment
      - GITHUB_STATE=success
      - GITHUB_DESCRIPTION=${CI_JOB_STATUS}
      - GITHUB_TARGET_URL=${DRONE_BUILD_LINK}
    when:
      status: [ success ]
      event: pull_request

  update-failed:
    image: cloudposse/github-status-updater
    secrets:
      - source: token
        target: GITHUB_TOKEN
    environment:
      - GITHUB_ACTION=update_state
      - GITHUB_OWNER=JieJhih
      - GITHUB_REPO=cicd
      - GITHUB_REF=${DRONE_COMMIT_SHA}
      - GITHUB_CONTEXT=Staging Environment
      - GITHUB_STATE=failure
      - GITHUB_DESCRIPTION=${CI_JOB_STATUS}
      - GITHUB_TARGET_URL=${DRONE_BUILD_LINK}
    when:
      status: [ failure ]
      event: pull_request